input {
  file {
    path => "/usr/share/logstash/logs/combined.log"
    start_position => "beginning"
    codec => "json"
  }
}

filter {
  if [service] == "cfm-estoque" {
    mutate {
      add_field => { "application" => "controle-estoque-cfm" }
    }
    
    # Parse do timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    # Categorização de logs
    if [level] == "error" {
      mutate {
        add_tag => [ "error", "alert" ]
      }
    }
    
    if [level] == "warn" {
      mutate {
        add_tag => [ "warning", "security" ]
      }
    }
    
    # Geolocalização por IP (opcional)
    if [ip] {
      geoip {
        source => "ip"
        target => "geoip"
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "cfm-estoque-logs-%{+YYYY.MM.dd}"
  }
  
  stdout {
    codec => rubydebug
  }
}