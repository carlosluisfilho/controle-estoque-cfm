<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrar Doa√ß√µes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
  <div class="container mt-5">
    <h2>Registrar Doa√ß√µes</h2>

    <!-- üîç Buscar alimento -->
    <div class="mb-3">
      <label for="searchFood" class="form-label">Buscar Item</label>
      <div class="d-flex">
        <input type="text" class="form-control" id="searchFood" placeholder="Digite o nome do item" />
        <button type="button" class="btn btn-info ms-2" id="btnSearchFood">Buscar</button>
      </div>
      <p id="searchResult" class="mt-2"></p>
    </div>

    <!-- üìã Formul√°rio de doa√ß√£o -->
    <form id="donationForm" class="mt-3">
      <div class="mb-3">
        <label for="donationFoodId" class="form-label">ID do Item</label>
        <input type="number" class="form-control" id="donationFoodId" required readonly />
      </div>
      <div class="mb-3">
        <label for="donationQuantity" class="form-label">Quantidade</label>
        <input type="number" class="form-control" id="donationQuantity" required />
      </div>
      <div class="mb-3">
        <label for="donorName" class="form-label">Nome do Doador</label>
        <input type="text" class="form-control" id="donorName" />
      </div>
      <div class="mb-3">
        <label for="donationDate" class="form-label">Data da Doa√ß√£o</label>
        <input type="date" class="form-control" id="donationDate" required />
      </div>
      <div class="mb-3">
        <label for="donationExpiration" class="form-label">Validade do Item Doado</label>
        <input type="date" class="form-control" id="donationExpiration" required />
      </div>
      <button type="submit" class="btn btn-success">Registrar Doa√ß√£o</button>
    </form>

    <!-- üîô Voltar e Logout -->
    <div class="d-flex gap-2 mt-4">
      <a href="/painel" class="btn btn-secondary">Voltar</a>
      <button id="logoutButton" class="btn btn-danger">Logout</button>
    </div>

    <!-- üìú Hist√≥rico -->
    <h3 class="mt-5">Hist√≥rico de Doa√ß√µes</h3>
    <table class="table table-bordered mt-3" id="donationHistory">
      <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Quantidade</th>
          <th>Doador</th>
          <th>Data da Doa√ß√£o</th>
          <th>Validade do Item</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- üîç Filtros para relat√≥rio -->
    <div class="row mt-4">
      <div class="col-md-4">
        <label>Data:</label>
        <input type="date" id="filtroData" class="form-control" />
      </div>
      <div class="col-md-4">
        <label>Doador:</label>
        <input type="text" id="filtroDoador" class="form-control" placeholder="Nome do Doador" />
      </div>
      <div class="col-md-4">
        <label>Item:</label>
        <input type="text" id="filtroAlimento" class="form-control" placeholder="Nome do Alimento" />
      </div>
    </div>

    <!-- üìä Bot√µes de relat√≥rio -->
    <div class="mt-4">
      <h3>Gerar Relat√≥rios</h3>
      <div class="d-flex gap-2">
        <a href="#" class="btn btn-danger" onclick="gerarRelatorio('pdf')">Gerar Relat√≥rio PDF</a>
        <a href="#" class="btn btn-warning" onclick="gerarRelatorio('excel')">Gerar Relat√≥rio Excel</a>
      </div>
    </div>
  </div>

  <script>
    // üö™ Logout
    document.getElementById('logoutButton').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    // üü¢ Inicializa√ß√£o
    document.addEventListener("DOMContentLoaded", () => {
      fetchDonationHistory();
      document.getElementById("donationForm").addEventListener("submit", registerDonation);
      document.getElementById("btnSearchFood").addEventListener("click", buscarAlimento);
    });

    // üîç Buscar alimento
    async function buscarAlimento() {
      const foodName = document.getElementById("searchFood").value.trim();
      const result = document.getElementById("searchResult");

      if (!foodName) {
        result.innerHTML = '<span class="text-danger">Digite um nome para buscar.</span>';
        return;
      }

      try {
        const res = await fetch(`/food?name=${encodeURIComponent(foodName)}`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        });

        const data = await res.json();

        if (Array.isArray(data) && data.length > 0) {
          document.getElementById("donationFoodId").value = data[0].id;
          document.getElementById("donationExpiration").value = data[0].expiration || "";
          result.innerHTML = `<span class="text-success">‚úÖ ${data[0].name} encontrado! Quantidade dispon√≠vel: ${data[0].quantity}</span>`;
        } else {
          result.innerHTML = '<span class="text-danger">‚ùå Item n√£o encontrado.</span>';
        }
      } catch (error) {
        console.error("Erro ao buscar item:", error);
        result.innerHTML = '<span class="text-danger">Erro ao buscar item.</span>';
      }
    }

    // ‚úÖ Registrar doa√ß√£o
    async function registerDonation(event) {
      event.preventDefault();

      const payload = {
        food_id: document.getElementById("donationFoodId").value,
        quantity: document.getElementById("donationQuantity").value,
        donor_name: document.getElementById("donorName").value,
        donation_date: document.getElementById("donationDate").value,
        expiration: document.getElementById("donationExpiration").value
      };

      try {
        const res = await fetch('/donation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Erro ao registrar doa√ß√£o.');

        alert("‚úÖ Doa√ß√£o registrada com sucesso!");
        document.getElementById("donationForm").reset();
        fetchDonationHistory();
        buscarAlimento();
      } catch (error) {
        console.error("Erro ao registrar doa√ß√£o:", error);
        alert(error.message);
      }
    }

    // üìã Carregar hist√≥rico
    async function fetchDonationHistory() {
      try {
        const res = await fetch('/donation', {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        });

        const data = await res.json();
        if (!Array.isArray(data)) {
          console.error("‚ùå Resposta inv√°lida:", data);
          return;
        }

        const tbody = document.querySelector('#donationHistory tbody');
        tbody.innerHTML = '';

        data.forEach(d => {
          tbody.innerHTML += `
            <tr>
              <td>${d.id}</td>
              <td>${d.food_name}</td>
              <td>${d.quantity}</td>
              <td>${d.donor_name || 'An√¥nimo'}</td>
              <td>${d.donation_date || '-'}</td>
              <td>${d.expiration || '-'}</td>
            </tr>`;
        });
      } catch (error) {
        console.error("Erro ao carregar hist√≥rico:", error);
      }
    }

    // üìÅ Gerar relat√≥rios
    async function gerarRelatorio(tipo) {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Usu√°rio n√£o autenticado.");
        window.location.href = "/login";
        return;
      }

      const url = `/relatorios/donations/${tipo}`;
      try {
        const res = await fetch(url, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Erro ao gerar relat√≥rio.");

        const blob = await res.blob();
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = downloadUrl;
        a.download = `relatorio_doacoes.${tipo === 'pdf' ? 'pdf' : 'xlsx'}`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(downloadUrl);
      } catch (error) {
        console.error("Erro ao gerar relat√≥rio:", error);
        alert(error.message);
      }
    }
  </script>

  <!-- ‚úÖ Scripts -->
  <script defer src="js/auth.js"></script>
</body>
</html>
